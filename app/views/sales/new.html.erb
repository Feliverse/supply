<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <%= render 'nav' %>
    </div>
    <main class="col-md-9 ml-sm-auto col-lg-10 px-md-4" style="background: rgba(255, 255, 255, 0.6); border-radius: 1rem;">
      <h1 class="text-center"><%= @almacen.name %></h1>
      <h2 class="text-center">Registrar Venta</h2>
      <p class="text-center">Por favor, llene el siguiente formulario para registrar una nueva venta.</p>
      <%= form_with(model: [@almacen, @sale], local: true) do |form| %>
        <% if @sale.errors.any? %>
          <div id="error_explanation">
            <h2><%= pluralize(@sale.errors.count, "error") %> prohibited this sale from being saved:</h2>

            <ul>
              <% @sale.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <%= render 'client', form: form %>

        <h2 class="text-center">Productos/Artículos</h2>
        <table class="table">
          <thead>
            <tr>
              <th>Cantidad</th>
              <th>Unidad de Medida</th>
              <th>Descripción</th>
              <th>Precio Unitario</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="products_table_body">
            <tr>
              <td><input type="number" class="form-control" name="sale[cantidades][]" /></td>
              <td><input type="text" class="form-control" name="sale[units][]" /></td>
              <td><input type="text" class="form-control description" name="sale[descriptions][]" /></td>
              <td><input type="number" class="form-control" name="sale[unit_prices][]" /></td>
              <td><input type="number" class="form-control" name="sale[totals][]" readonly /></td>
            </tr>
          </tbody>
        </table>
        <div class="form-group text-center">
          <button type="button" class="btn btn-secondary" id="add_product">Agregar Producto</button>
        </div>

        <div class="form-group">
          <label>Total Final:</label>
          <input type="number" class="form-control" id="final_total" readonly />
        </div>

        <div class="form-group text-center">
          <%= form.submit 'Crear Venta', class: 'btn btn-primary' %>
        </div>
      <% end %>

      <div class="text-center">
        <%= link_to 'Cancelar', sales_path, class: 'btn btn-secondary' %>
      </div>
    </main>
  </div>
</div>

<%# Include jQuery and jQuery UI %>
<%= javascript_include_tag 'https://code.jquery.com/jquery-3.6.0.min.js' %>
<%= javascript_include_tag 'https://code.jquery.com/ui/1.12.1/jquery-ui.min.js' %>
<%= stylesheet_link_tag 'https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css' %>

<script>
  window.addEventListener('message', function(event) {
    if (event.data.cliente) {
      document.getElementById('client_nit').value = event.data.cliente.nit;
      document.getElementById('client_name').value = event.data.cliente.name;
      document.getElementById('cliente_id').value = event.data.cliente.id;
    }
  });

  document.getElementById('client_nit').addEventListener('blur', function() {
    var clientNit = this.value;
    if (clientNit) {
      fetch('/clientes/find_by_nit?nit=' + clientNit)
        .then(response => response.json())
        .then(data => {
          if (data.id) {
            document.getElementById('client_name').value = data.name;
            document.getElementById('cliente_id').value = data.id;
          } else {
            alert('Cliente no encontrado. Por favor, cree un nuevo cliente.');
            document.getElementById('client_name').value = '';
            document.getElementById('cliente_id').value = '';
          }
        });
    }
  });

  document.getElementById('edit_client').addEventListener('click', function() {
    var clientId = this.dataset.clientId;
    if (clientId) {
      window.open('/clientes/' + clientId + '/edit', '_blank', 'width=600,height=400');
    } else {
      alert('Primero seleccione un cliente.');
    }
  });

  function bindDescriptionEvent(element) {
    $(element).autocomplete({
      source: function(request, response) {
        fetch('/almacens/<%= @almacen.id %>/inventarios.json')
          .then(response => response.json())
          .then(data => {
            var results = data.map(inventario => {
              var name = inventario.product ? inventario.product.name : inventario.articulo.name;
              return {
                label: `${name} - ${inventario.cantidad_disponible} disponibles`,
                value: name
              };
            });
            response(results);
          });
      },
      minLength: 1,
      select: function(event, ui) {
        $(this).val(ui.item.value);
        return false;
      }
    }).on('blur', function() {
      var valid = false;
      var value = $(this).val();
      $(this).autocomplete('option', 'source', function(request, response) {
        fetch('/almacens/<%= @almacen.id %>/inventarios.json')
          .then(response => response.json())
          .then(data => {
            var results = data.map(inventario => {
              var name = inventario.product ? inventario.product.name : inventario.articulo.name;
              return {
                label: `${name} - ${inventario.cantidad_disponible} disponibles`,
                value: name
              };
            });
            response(results);
            results.forEach(function(item) {
              if (item.value === value) {
                valid = true;
              }
            });
            if (!valid) {
              $(this).val('');
              alert('Por favor, seleccione un producto válido de la lista.');
            }
          });
      });
    });
  }

  document.getElementById('add_product').addEventListener('click', function() {
    var tableBody = document.getElementById('products_table_body');
    var newRow = tableBody.rows[0].cloneNode(true);
    newRow.querySelectorAll('input').forEach(input => input.value = '');
    bindDescriptionEvent(newRow.querySelector('.description'));
    tableBody.appendChild(newRow);
  });

  document.getElementById('products_table_body').addEventListener('input', function() {
    var rows = this.querySelectorAll('tr');
    var finalTotal = 0;
    rows.forEach(row => {
      var cantidad = row.querySelector('input[name="sale[cantidades][]"]').value;
      var unitPrice = row.querySelector('input[name="sale[unit_prices][]"]').value;
      var total = row.querySelector('input[name="sale[totals][]"]');
      total.value = cantidad * unitPrice;
      finalTotal += parseFloat(total.value) || 0;
    });
    document.getElementById('final_total').value = finalTotal;
  });

  document.querySelectorAll('.description').forEach(bindDescriptionEvent);

  document.getElementById('sale_form').addEventListener('submit', function(event) {
    var descriptions = document.querySelectorAll('.description');
    var valid = true;
    descriptions.forEach(function(description) {
      if (description.value === '') {
        valid = false;
      }
    });
    if (!valid) {
      event.preventDefault();
      alert('Por favor, seleccione productos válidos de la lista.');
    }
  });
</script>
