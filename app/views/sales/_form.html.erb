<%= form_with(model: sale, local: true) do |form| %>
  <% if sale.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(sale.errors.count, "error") %> prohibited this sale from being saved:</h2>

      <ul>
        <% sale.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field">
    <%= form.label :fecha %>
    <%= form.datetime_select :fecha %>
  </div>

  <div class="field">
    <%= form.label :cliente_id %>
    <%= form.collection_select :cliente_id, Cliente.all, :id, :name %>
  </div>

  <div class="field">
    <%= form.label :almacen_id %>
    <%= form.collection_select :almacen_id, Almacen.all, :id, :name %>
  </div>

  <div class="field">
    <%= form.label :unidad_de_medida %>
    <%= form.text_field :unidad_de_medida %>
  </div>

  <div class="field">
    <%= form.label :precio_unitario %>
    <%= form.number_field :precio_unitario, step: 0.01 %>
  </div>

  <div id="sale_items">
    <%= form.fields_for :sale_items do |item_form| %>
      <%= render 'sale_item_fields', f: item_form %>
    <% end %>
  </div>

  <div class="actions">
    <%= form.submit %>
  </div>
<% end %>

<%= link_to_add_fields "Add Item", form, :sale_items %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('add_item').addEventListener('click', function() {
      var template = document.getElementById('sale_item_template').content.cloneNode(true);
      var newId = new Date().getTime();
      template.querySelectorAll('input, select').forEach(function(input) {
        input.name = input.name.replace('new', newId);
        input.id = input.id.replace('new', newId);
      });
      document.getElementById('sale_items').appendChild(template);
    });

    document.getElementById('sale_items').addEventListener('click', function(event) {
      if (event.target.classList.contains('remove_item')) {
        event.target.closest('.nested-fields').remove();
      }
    });

    document.getElementById('sale_items').addEventListener('change', function(event) {
      if (event.target.tagName === 'SELECT') {
        var selectedOption = event.target.options[event.target.selectedIndex];
        var availableQuantity = selectedOption.getAttribute('data-available-quantity');
        var quantitySpan = event.target.closest('.field').querySelector('.available_quantity');
        quantitySpan.textContent = availableQuantity ? `Available: ${availableQuantity}` : '';
      }
    });
  });

  document.getElementById("client_nit").addEventListener("blur", function() {
    var nit = this.value;
    if (nit) {
      fetch(`/clientes/find_by_nit?nit=${nit}`)
        .then(response => response.json())
        .then(data => {
          if (data && data.id) {
            document.getElementById("cliente_id_hidden").value = data.id;
            document.getElementById("client_name").value = data.name;
            document.getElementById("edit_client").dataset.clientId = data.id;
          } else {
            if (confirm("Cliente no encontrado. Â¿Desea crear un nuevo cliente?")) {
              window.open(`/clientes/new?nit=${nit}`, '_blank', 'width=600,height=400');
            }
            document.getElementById("client_name").value = "";
            document.getElementById("cliente_id_hidden").value = "";
          }
        });
    }
  });

  document.getElementById('edit_client').addEventListener('click', function() {
    document.getElementById("client_name").removeAttribute("readonly");
    document.getElementById("edit_client").classList.add("d-none");
    document.getElementById("save_client").classList.remove("d-none");
  });

  document.getElementById('save_client').addEventListener('click', function() {
    var clientId = document.getElementById("cliente_id_hidden").value;
    var clientName = document.getElementById("client_name").value;
    if (clientId && clientName) {
      fetch(`/clientes/${clientId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({ cliente: { name: clientName } })
      })
      .then(response => response.json())
      .then(data => {
        if (data.id) {
          document.getElementById("client_name").setAttribute("readonly", true);
          document.getElementById("edit_client").classList.remove("d-none");
          document.getElementById("save_client").classList.add("d-none");
        } else {
          alert("Error al actualizar el cliente.");
        }
      });
    } else {
      alert('Primero seleccione un cliente.');
    }
  });
</script>
