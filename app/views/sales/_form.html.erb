<%= form_with(model: [@almacen, @sale], local: true, id: "sale_form") do |form| %>
  <% if @sale.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@sale.errors.count, "error") %> prohibited this sale from being saved:</h2>

      <ul>
        <% @sale.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field">
    <%= form.label :cliente_id %>
    <%= form.collection_select :cliente_id, Cliente.all, :id, :name %>
  </div>

  <h3>Sale Items</h3>
  <div id="sale_items">
    <%= form.fields_for :sale_items do |item_form| %>
      <div class="nested-fields">
        <div class="field">
          <%= item_form.label :product_id %>
          <%= item_form.collection_select :product_id, Product.all, :id, :name, include_blank: true %>
        </div>
        <div class="field">
          <%= item_form.label :articulo_id %>
          <%= item_form.collection_select :articulo_id, Articulo.all, :id, :name, include_blank: true %>
        </div>
        <div class="field">
          <%= item_form.label :cantidad %>
          <%= item_form.number_field :cantidad %>
        </div>
        <div class="field">
          <%= item_form.label :unidad_de_medida %>
          <%= item_form.text_field :unidad_de_medida %>
        </div>
        <div class="field">
          <%= item_form.label :precio_unitario %>
          <%= item_form.number_field :precio_unitario, step: 0.01 %>
        </div>
        <%= link_to_remove_association "Remove Item", item_form %>
      </div>
    <% end %>
  </div>
  <%= link_to_add_association "Add Item", form, :sale_items %>

  <div class="actions">
    <%= form.submit %>
  </div>
<% end %>

<script>
  document.getElementById("client_nit").addEventListener("blur", function() {
    var nit = this.value;
    if (nit) {
      fetch(`/clientes/find_by_nit?nit=${nit}`)
        .then(response => response.json())
        .then(data => {
          if (data && data.id) {
            document.getElementById("cliente_id_hidden").value = data.id;
            document.getElementById("client_name").value = data.name;
            document.getElementById("edit_client").dataset.clientId = data.id;
          } else {
            if (confirm("Cliente no encontrado. ¿Desea crear un nuevo cliente?")) {
              window.open(`/clientes/new?nit=${nit}`, '_blank', 'width=600,height=400');
            }
            document.getElementById("client_name").value = "";
            document.getElementById("cliente_id_hidden").value = "";
          }
        });
    }
  });

  document.getElementById('edit_client').addEventListener('click', function() {
    document.getElementById("client_name").removeAttribute("readonly");
    document.getElementById("edit_client").classList.add("d-none");
    document.getElementById("save_client").classList.remove("d-none");
  });

  document.getElementById('save_client').addEventListener('click', function() {
    var clientId = document.getElementById("cliente_id_hidden").value;
    var clientName = document.getElementById("client_name").value;
    if (clientId && clientName) {
      fetch(`/clientes/${clientId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({ cliente: { name: clientName } })
      })
      .then(response => response.json())
      .then(data => {
        if (data.id) {
          document.getElementById("client_name").setAttribute("readonly", true);
          document.getElementById("edit_client").classList.remove("d-none");
          document.getElementById("save_client").classList.add("d-none");
        } else {
          alert("Error al actualizar el cliente.");
        }
      });
    } else {
      alert('Primero seleccione un cliente.');
    }
  });

  document.getElementById('add_product').addEventListener('click', function() {
    var tableBody = document.getElementById('products_table_body');
    var newRow = tableBody.rows[0].cloneNode(true);
    newRow.querySelectorAll('input').forEach(input => input.value = '');
    tableBody.appendChild(newRow);
  });

  document.getElementById('products_table_body').addEventListener('input', function() {
    var rows = this.querySelectorAll('tr');
    var finalTotal = 0;
    rows.forEach(row => {
      var cantidad = row.querySelector('input[name="sale[cantidades][]"]').value;
      var unitPrice = row.querySelector('input[name="sale[unit_prices][]"]').value;
      var total = row.querySelector('input[name="sale[totals][]"]');
      total.value = cantidad * unitPrice;
      finalTotal += parseFloat(total.value) || 0;
    });
    document.getElementById('final_total').value = finalTotal;
  });

  document.getElementById('sale_form').addEventListener('submit', function(event) {
    var descriptions = document.querySelectorAll('.description');
    var valid = true;
    descriptions.forEach(function(description) {
      if (description.value === '') {
        valid = false;
      }
    });
    if (!valid) {
      event.preventDefault();
      alert('Por favor, seleccione productos válidos de la lista.');
    }
  });
</script>
