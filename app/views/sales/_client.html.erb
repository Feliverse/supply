<div class="form-group">
  <%= form.label :client_nit, "NIT del Cliente", class: "form-label" %>
  <%= form.text_field :client_nit, id: "client_nit", class: "form-control" %>
</div>

<div class="form-group">
  <%= form.label :client_name, "Nombre del Cliente", class: "form-label" %>
  <div class="input-group">
    <%= form.text_field :client_name, id: "client_name", class: "form-control", readonly: true %>
    <div class="input-group-append">
      <button type="button" class="btn btn-outline-secondary" id="edit_client" title="Editar Cliente">
        <i class="fas fa-edit"></i>
      </button>
      <button type="button" class="btn btn-outline-secondary d-none" id="save_client" title="Guardar Cliente">
        <i class="fas fa-save"></i>
      </button>
    </div>
  </div>
</div>

<div class="form-group">
  <%= form.hidden_field :cliente_id, id: "cliente_id" %>
</div>

<script>
  document.getElementById("client_nit").addEventListener("blur", function() {
    var nit = this.value;
    if (nit) {
      fetch(`/clientes/find_by_nit?nit=${nit}`)
        .then(response => response.json())
        .then(data => {
          if (data && data.id) {
            document.getElementById("cliente_id").value = data.id;
            document.getElementById("client_name").value = data.name;
            document.getElementById("edit_client").dataset.clientId = data.id;
          } else {
            if (confirm("Cliente no encontrado. Â¿Desea crear un nuevo cliente?")) {
              window.open(`/clientes/new?nit=${nit}`, '_blank', 'width=600,height=400');
            }
            document.getElementById("client_name").value = "";
            document.getElementById("cliente_id").value = "";
          }
        });
    }
  });

  document.getElementById('edit_client').addEventListener('click', function() {
    document.getElementById("client_name").removeAttribute("readonly");
    document.getElementById("edit_client").classList.add("d-none");
    document.getElementById("save_client").classList.remove("d-none");
  });

  document.getElementById('save_client').addEventListener('click', function() {
    var clientId = document.getElementById("cliente_id").value;
    var clientName = document.getElementById("client_name").value;
    if (clientId && clientName) {
      fetch(`/clientes/${clientId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        },
        body: JSON.stringify({ cliente: { name: clientName } })
      })
      .then(response => response.json())
      .then(data => {
        if (data.id) {
          document.getElementById("client_name").setAttribute("readonly", true);
          document.getElementById("edit_client").classList.remove("d-none");
          document.getElementById("save_client").classList.add("d-none");
        } else {
          alert("Error al actualizar el cliente.");
        }
      });
    } else {
      alert('Primero seleccione un cliente.');
    }
  });
</script>
